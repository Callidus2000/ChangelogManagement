name: $(BuildId)

trigger:
  branches:
    include:
      - master

variables:
  - group: ReleaseSecrets
  - name: PowerShellModules
    value: ChangelogManagement,InvokeBuild,Pester,platyPS,MarkdownToHtml,BuildHelpers,PowerShellGet
  - name: LinkPattern
    value: '@{FirstRelease="https://github.com/$env:BUILD_REPOSITORY_NAME/tree/v{CUR}";NormalRelease="https://github.com/$env:BUILD_REPOSITORY_NAME/compare/v{PREV}..v{CUR}";Unreleased="https://github.com/$env:BUILD_REPOSITORY_NAME/compare/v{CUR}..HEAD"}'
  - name: GitName
    value: Nate Scherer
  - name: GitEmail
    value: 376408+natescherer@users.noreply.github.com
  - name: LicenseUri
    value: https://github.com/$env:BUILD_REPOSITORY_NAME/blob/master/LICENSE
  - name: ProjectUri
    value: https://github.com/$env:BUILD_REPOSITORY_NAME
  - name: HelpInfoUri
    value: https://github.com/$env:BUILD_REPOSITORY_NAME

stages:
- stage: Build
  jobs:
  - job: ubuntu_latest
    pool: 
      vmImage: ubuntu-latest
    steps:
    - template: azure-pipelines-build-steps.yml
      parameters:
        tempDir: /tmp
        moduleInstallOptions: -Scope CurrentUser
        artifactName: ubuntu-latest
  - job: macos_latest
    pool: 
      vmImage: macoslatest
    steps:
    - template: azure-pipelines-build-steps.yml
      parameters:
        tempDir: $env:TMPDIR
        artifactName: macos-latest
  - job: windows_latest_w_windows_powershell
    pool: 
      vmImage: windows-latest
    steps:
    - template: azure-pipelines-build-steps.yml
      parameters:
        tempDir: $env:TEMP
        pwsh: false
        artifactName: windows-latest_w_windows_powershell
  - job: windows_latest
    pool: 
      vmImage: windows-latest
    steps:
    - template: azure-pipelines-build-steps.yml
      parameters:
        tempDir: $env:TEMP
        artifactName: windows-latest
- stage: DeployDev
  condition: eq(variables['PrdVersion'], '')
  jobs:
  - deployment: DeployDev
    pool:
      vmImage: windows-latest
    environment: DEV
    strategy:
      runOnce:
        deploy:
          steps:
          - template: azure-pipelines-deploy-steps.yml
            parameters:
              environmentName: DEV
              artifactName: windows-latest
- stage: DeployPrd
  condition: ne(variables['PrdVersion'], '')
  jobs:
  - deployment: DeployPrd
    pool:
      vmImage: windows-latest
    environment: PRD
    strategy:
      runOnce:
        deploy:
          steps:
          - template: azure-pipelines-deploy-steps.yml
            parameters:
              environmentName: PRD
              artifactName: windows-latest