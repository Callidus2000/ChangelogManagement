name: $(BuildId)

trigger:
  branches:
    include:
      - master

variables:
  - group: ReleaseSecrets
  - name: PowerShellModules
    value: ChangelogManagement,InvokeBuild,Pester,platyPS,MarkdownToHtml,BuildHelpers,PowerShellGet
  - name: LinkPattern
    value: '@{FirstRelease="https://github.com/$env:BUILD_REPOSITORY_NAME/tree/v{CUR}";NormalRelease="https://github.com/$env:BUILD_REPOSITORY_NAME/compare/v{PREV}..v{CUR}";Unreleased="https://github.com/$env:BUILD_REPOSITORY_NAME/compare/v{CUR}..HEAD"}'
  - name: GitName
    value: Nate Scherer
  - name: GitEmail
    value: 376408+natescherer@users.noreply.github.com
  - name: LicenseUri
    value: https://github.com/$env:BUILD_REPOSITORY_NAME/blob/master/LICENSE
  - name: ProjectUri
    value: https://github.com/$env:BUILD_REPOSITORY_NAME
  - name: HelpInfoUri
    value: https://github.com/$env:BUILD_REPOSITORY_NAME

stages:
- stage: Build
  - template: azure-pipelines-build-steps.yml
    parameters:
      name: ubuntu-latest
      vmImage: ubuntu-latest
      tempDir: /tmp
      moduleInstallOptions: -Scope CurrentUser
  - template: azure-pipelines-build-steps.yml
    parameters:
      name: macos-latest
      vmImage: macos-latest
      tempDir: $env:TMPDIR
  - template: azure-pipelines-build-steps.yml
    parameters:
      name: windows-latest_w_windows_powershell
      vmImage: windows-latest
      tempDir: $env:TEMP
      pwsh: false
  - template: azure-pipelines-build-steps.yml
    parameters:
      name: windows-latest_w_powershell_core
      vmImage: windows-latest
      tempDir: $env:TEMP
- stage: DeployDev
  condition: eq(variables['PrdVersion'], '')
  jobs:
  - deployment: DeployDev
    pool:
      vmImage: windows-latest
    environment: DEV
    strategy:
      runOnce:
        deploy:
          steps:
          - template: azure-pipelines-deploy-steps.yml
            parameters:
              environmentName: DEV
- stage: DeployPrd
  condition: ne(variables['PrdVersion'], '')
  jobs:
  - deployment: DeployPrd
    pool:
      vmImage: windows-latest
    environment: PRD
    strategy:
      runOnce:
        deploy:
          steps:
          - template: azure-pipelines-deploy-steps.yml
            parameters:
              environmentName: PRD